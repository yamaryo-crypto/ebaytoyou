# eBay 画像盗用監視ツール - 使い方ガイド

このガイドでは、eBay Developer、Google Cloud、セットアップからWeb UIでの実行まで、すべて詳しく説明します。

## 📋 目次

- [このツールについて](#このツールについて)
- [必要な準備](#必要な準備)
- [ステップ1: eBay Developer アカウントの準備](#ステップ1-ebay-developer-アカウントの準備)
- [ステップ2: Google Cloud プロジェクトの準備](#ステップ2-google-cloud-プロジェクトの準備)
- [ステップ3: プロジェクトのセットアップ](#ステップ3-プロジェクトのセットアップ)
- [ステップ4: Web UI での実行](#ステップ4-web-ui-での実行)
- [ステップ5: 結果の確認](#ステップ5-結果の確認)
- [よくある質問](#よくある質問)

---

## このツールについて

このツールは、あなたのeBay出品画像が他の出品者に無断使用されていないかを自動で監視するツールです。

### 主な機能

- ✅ **自動検知**: あなたの出品画像と完全一致する画像を使っている他出品を自動で見つける
- ✅ **スプレッドシート出力**: 検知結果を Google スプレッドシートに自動記録
- ✅ **メッセージ文面生成**: 相手に送るメッセージの件名・本文を自動生成
- ✅ **重複防止**: 同じ検知は2回登録されない
- ✅ **週次実行**: 最大100出品ずつ、公平にローテーション処理

---

## 必要な準備

### 1. 必要なアカウント

- **eBay アカウント**: 出品者アカウント（既にお持ちのアカウントでOK）
- **eBay Developer アカウント**: APIを使用するために必要（無料で作成可能）
- **Google アカウント**: Google Cloud と Google スプレッドシートを使用するため

### 2. 必要なソフトウェア

- **Python 3.11以上**: `python3 --version` で確認
- **ターミナル（コマンドライン）**: Mac/Linux の標準ターミナル、Windows の PowerShell またはコマンドプロンプト

---

## ステップ1: eBay Developer アカウントの準備

### 1-1. eBay Developer アカウントを作成

1. [eBay Developers Program](https://developer.ebay.com/) にアクセス
2. 「Sign In」をクリックして、eBayアカウントでログイン
3. 初回の場合は、開発者登録フォームに必要事項を入力して登録

### 1-2. アプリケーションを作成

1. ログイン後、「My Account」→「Keys」をクリック
2. 「Create an App Key」または「Request Production Keys」をクリック
3. アプリケーション情報を入力：
   - **App Name**: 任意の名前（例: "画像監視ツール"）
   - **App Type**: "Web Application" を選択
   - **Redirect URI**: `https://auth.ebay.com/oauth2/consent` を入力
4. 「Create」をクリック

### 1-3. Client ID と Client Secret を取得

1. 作成したアプリケーションをクリック
2. **Client ID** と **Client Secret** をコピー（後で使用します）
   - 例: `Client ID: ryoyamaz-hanachan-PRD-xxxxx`
   - 例: `Client Secret: PRD-xxxxx-xxxxx-xxxxx`

### 1-4. User Token（Refresh Token）を取得

Trading APIを使用するために、User Tokenが必要です。

#### 方法1: スクリプトを使用する（推奨）

1. プロジェクトの `scripts/get_new_refresh_token.py` を実行：
   ```bash
   cd /path/to/ebaynisemonotool
   source .venv/bin/activate
   python scripts/get_new_refresh_token.py
   ```

2. 表示された認証URLをブラウザで開く

3. eBayにログインして、アプリの認証を許可

4. リダイレクト後のURLから認証コード（`code=XXXXX`の部分）をコピー

5. ターミナルに認証コードを貼り付けてEnter

6. 表示された `EBAY_USER_REFRESH_TOKEN` の値をコピー（後で使用します）

#### 方法2: eBay Developer Console から直接取得

1. eBay Developer Console で「User Tokens」セクションを確認
2. 必要に応じて、OAuth認証フローを実行してRefresh Tokenを取得

---

## ステップ2: Google Cloud プロジェクトの準備

### 2-1. Google Cloud プロジェクトを作成

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. Googleアカウントでログイン
3. プロジェクト選択ドロップダウンから「新しいプロジェクト」をクリック
4. プロジェクト名を入力（例: "ebay-image-monitor"）して「作成」

### 2-2. Google Sheets API を有効化

1. 「APIとサービス」→「ライブラリ」をクリック
2. 検索ボックスに「Google Sheets API」と入力
3. 「Google Sheets API」をクリック
4. 「有効にする」をクリック

### 2-3. サービスアカウントを作成

1. 「認証情報」→「認証情報を作成」→「サービスアカウント」を選択
2. サービスアカウント名を入力（例: "ebay-monitor-service"）
3. 「作成して続行」をクリック
4. ロールは「編集者」を選択（またはスキップ）
5. 「完了」をクリック

### 2-4. サービスアカウントキーをダウンロード

1. 作成したサービスアカウントをクリック
2. 「キー」タブをクリック
3. 「キーを追加」→「新しいキーを作成」をクリック
4. 「JSON」を選択して「作成」
5. JSONファイルがダウンロードされます

### 2-5. JSONファイルを保存

1. ダウンロードしたJSONファイルを `secrets/service_account.json` に保存
   ```bash
   # プロジェクトフォルダ内で実行
   mkdir -p secrets
   mv ~/Downloads/your-project-xxxxx.json secrets/service_account.json
   ```

2. JSONファイル内の `client_email` の値をメモ（後で使用します）
   - 例: `ebay-monitor-service@your-project.iam.gserviceaccount.com`

### 2-6. Google スプレッドシートを作成

1. [Google スプレッドシート](https://sheets.google.com/) にアクセス
2. 「空白」をクリックして新しいスプレッドシートを作成
3. スプレッドシートのURLから **スプレッドシートID** を取得
   - URL例: `https://docs.google.com/spreadsheets/d/1a2b3c4d5e6f7g8h9i0j/edit`
   - この場合、IDは `1a2b3c4d5e6f7g8h9i0j`
4. スプレッドシートをサービスアカウントのメールアドレスに「編集者」権限で共有
   - 「共有」ボタンをクリック
   - サービスアカウントのメールアドレス（JSONファイルの `client_email`）を入力
   - 権限を「編集者」に設定
   - 「送信」をクリック

---

## ステップ3: プロジェクトのセットアップ

### 3-1. プロジェクトをダウンロードまたはクローン

```bash
cd /path/to/your/workspace
# 既にプロジェクトフォルダがある場合はその中で作業
```

### 3-2. 仮想環境を作成

**Mac/Linux:**
```bash
python3 -m venv .venv
```

**Windows:**
```bash
python -m venv .venv
```

### 3-3. 仮想環境を有効化

**Mac/Linux:**
```bash
source .venv/bin/activate
```

**Windows:**
```bash
.venv\Scripts\activate
```

有効化されると、プロンプトの前に `(.venv)` が表示されます。

### 3-4. 依存パッケージをインストール

```bash
pip install -r requirements.txt
```

### 3-5. 設定ファイルを作成

#### `.env` ファイルを作成

```bash
cp .env.example .env
```

`.env` ファイルを開いて、以下の値を入力してください：

```env
# eBay API 設定（必須）
EBAY_CLIENT_ID=あなたのClient_ID
EBAY_CLIENT_SECRET=あなたのClient_Secret
EBAY_MARKETPLACE_ID=EBAY_US
EBAY_SELLER_USERNAME=あなたのeBayユーザー名
EBAY_USER_REFRESH_TOKEN=あなたのRefresh_Token

# Google Sheets 設定（必須）
GOOGLE_SHEETS_ID=スプレッドシートID
GOOGLE_SERVICE_ACCOUNT_JSON_PATH=./secrets/service_account.json

# HTTP 設定（オプション、デフォルト値でOK）
HTTP_TIMEOUT_SEC=30
HTTP_RETRY_MAX=3
HTTP_RETRY_BACKOFF_SEC=2
```

**重要**: 
- `EBAY_CLIENT_ID` と `EBAY_CLIENT_SECRET` は、ステップ1-3で取得した値を入力
- `EBAY_USER_REFRESH_TOKEN` は、ステップ1-4で取得した値を入力
- `EBAY_SELLER_USERNAME` は、あなたのeBayユーザー名を入力
- `GOOGLE_SHEETS_ID` は、ステップ2-6で取得したスプレッドシートIDを入力

#### `config.yaml` ファイルを作成（オプション）

```bash
cp config.yaml.example config.yaml
```

`config.yaml` は基本的にデフォルトのままでOKですが、必要に応じて調整できます。

---

## ステップ4: Web UI での実行

### 4-1. Web UI を起動

```bash
# 仮想環境を有効化（まだの場合）
source .venv/bin/activate  # Windows: .venv\Scripts\activate

# Streamlit を起動
streamlit run app/web.py
```

ブラウザが自動的に開き、`http://localhost:8501` でアクセスできます。

### 4-2. 画面の使い方

#### 🏠 ダッシュボード

- 総実行回数、総検知数、未対応検知数などの統計情報
- 最近の実行履歴を一覧表示

#### ⚙️ 設定

- **環境変数タブ**: `.env` ファイルの編集（eBay API、Google Sheets の設定）
- **設定ファイルタブ**: `config.yaml` の編集（処理数、メッセージ設定など）

#### ▶️ 実行

- **アカウント検証**: eBay APIへの接続をテスト
- **実行開始**: 実際の検知処理を開始
- **実行ログ**: リアルタイムでログを確認

#### 📊 結果確認

- 検知結果一覧（侵害セラー、出品URL、ステータスなど）
- 実行履歴の詳細
- Google スプレッドシートへの直接リンク
- CSVダウンロード

### 4-3. 実行手順

1. **設定画面**で `.env` と `config.yaml` を確認・編集
2. **実行画面**で「アカウント検証」ボタンをクリックして接続を確認
3. **実行画面**で「実行開始」ボタンをクリック
4. 実行中はログが表示され、完了すると結果が更新されます
5. **結果確認画面**で検知結果を確認

---

## ステップ5: 結果の確認

### 5-1. Web UI で確認

1. 「結果確認」ページを開く
2. 検知結果一覧を確認
3. 各検知の詳細情報（侵害セラー、出品URL、メッセージ文面など）を確認
4. 必要に応じてCSVをダウンロード

### 5-2. Google スプレッドシートで確認

1. Google スプレッドシートを開く
2. `detections` シートを確認
3. 以下の列で結果が記録されます：
   - `detected_at`: 検知日時
   - `your_item_id`: あなたの出品ID
   - `your_item_url`: あなたの出品URL
   - `infringing_seller_display`: 侵害しているセラーの表示名
   - `infringing_item_url`: 侵害している出品のURL
   - `infringing_image_preview`: 侵害画像のプレビュー
   - `match_evidence`: 一致証拠（`sha256` / `url` / `perceptual`）
   - `message_subject`: 送信用件名
   - `message_body`: 送信用本文
   - `status`: ステータス（`NEW` = 未送信）

### 5-3. メッセージの送信

1. スプレッドシートの `message_subject` と `message_body` をコピー
2. eBayの該当出品ページから「質問を送る」をクリック
3. 件名と本文を貼り付けて送信
4. スプレッドシートの `status` を `SENT` などに更新（手動）

---

## よくある質問

### Q: アカウント検証でエラーが出ます

A: 以下を確認してください：
- `.env` ファイルの `EBAY_CLIENT_ID` と `EBAY_CLIENT_SECRET` が正しいか
- `EBAY_USER_REFRESH_TOKEN` が正しく設定されているか
- eBay Developer Console でアプリケーションが有効になっているか

### Q: 実行しても検知が0件です

A: 以下を確認してください：
- `EBAY_SELLER_USERNAME` が正しいか
- 実際に出品があるか
- Trading API が正しく動作しているか（`scripts/test_trading_api.py` で確認）

### Q: Google スプレッドシートに書き込めません

A: 以下を確認してください：
- サービスアカウントのJSONファイルが `secrets/service_account.json` にあるか
- スプレッドシートをサービスアカウントのメールアドレスに「編集者」権限で共有しているか
- Google Sheets API が有効化されているか

### Q: 処理時間はどのくらいかかりますか？

A: 100出品 × 3画像 × 50候補 = 最大15,000件の画像照合が必要です。API レート制限とネットワーク速度に依存しますが、30分〜2時間程度が目安です。

### Q: メッセージは自動送信されますか？

A: いいえ。v1.0 では自動送信は行いません。スプレッドシートに生成された `message_subject` と `message_body` をコピーして、手動で送信してください。

### Q: 同じ検知が2回登録されませんか？

A: いいえ。SQLite で `your_item_id × infringing_item_id` の組み合わせが UNIQUE 制約になっているため、同じ検知は1回だけ登録されます。

---

## トラブルシューティング

詳細は `README.md` の「トラブルシューティング」セクションを参照してください。

---

## サポート

詳細な仕様は `SPEC.md` を参照してください。

問題が解決しない場合は、以下を確認してください：
- Python バージョン（3.11以上）
- すべての依存パッケージがインストールされているか（`pip list`）
- `.env` と `config.yaml` の設定が正しいか
- ログファイル（`logs/run.log`）のエラーメッセージ
